# coding: utf-8
"""
"""
# stdlib imports
import unittest
#  from unittest.mock import patch
import os
from datetime import datetime
from decimal import Decimal


# 3rd party imports
from sqlalchemy import create_engine
import ofxtools


# local imports
from capgains.ofx.scottrade import (
    OfxStatementReader,
)
from capgains.models.transactions import (
    Fi, FiAccount, Security, Transaction
)
from capgains.database import Session, Base


DB_URI = os.getenv('DB', 'sqlite://')


def setUpModule():
    """
    Called by unittest.TestRunner before any other tests in this module.
    """
    global engine
    engine = create_engine(DB_URI)


def tearDownModule():
    engine.dispose()


class DatabaseTest(object):
    """ Mixin providing DB setup/teardown methods """
    def setUp(self):
        self.connection = engine.connect()
        self.transaction = self.connection.begin()
        self.session = Session(bind=self.connection)
        Base.metadata.create_all(bind=self.connection)
        self.reader = OfxStatementReader(self.session)

    def tearDown(self):
        self.session.close()
        self.transaction.rollback()
        self.connection.close()


class TradeTestCase(DatabaseTest, unittest.TestCase):
    def filterTradesTestCase(self):
        pass

    def filterTradeCancelsTestCase(self):
        pass

    def sortCanceledTradesTestCase(self):
        pass

    def testTradesCancel(self):
        ofx = """
        <INVTRANLIST><DTSTART>20100914010000.000[-4:EDT]<DTEND>20120314010000.000[-4:EDT]<BUYSTOCK><INVBUY><INVTRAN><FITID>561786865C<DTTRADE>20120227120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>45498<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-27753.78<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615057C<DTTRADE>20120224120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>13501<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-8235.61<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448657C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>6000<UNITPRICE>0.61<COMMISSION>18.3<TAXES>0<FEES>0<TOTAL>-3678.3<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615056C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>6000<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-3660<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615069C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-6000<UNITPRICE>0.61<COMMISSION>18.3<TAXES>0<FEES>0<TOTAL>3641.7<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615067C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-10000<UNITPRICE>0.61<COMMISSION>30.5<TAXES>0<FEES>0<TOTAL>6069.5<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448655C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>10000<UNITPRICE>0.61<COMMISSION>30.5<TAXES>0<FEES>0<TOTAL>-6130.5<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448653C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>6000<UNITPRICE>0.61<COMMISSION>18.3<TAXES>0<FEES>0<TOTAL>-3678.3<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615065C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-6000<UNITPRICE>0.61<COMMISSION>18.3<TAXES>0<FEES>0<TOTAL>3641.7<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448649C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>10000<UNITPRICE>0.61<COMMISSION>30.5<TAXES>0<FEES>0<TOTAL>-6130.5<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615051C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>10000<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-6100<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615061C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-10000<UNITPRICE>0.61<COMMISSION>30.5<TAXES>0<FEES>0<TOTAL>6069.5<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615063C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-9000<UNITPRICE>0.61<COMMISSION>34.45<TAXES>0<FEES>0<TOTAL>5455.55<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615053C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>9000<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-5490<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561280142C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>41000<UNITPRICE>0.61<COMMISSION>132.05<TAXES>0<FEES>0<TOTAL>-25142.05<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561448644C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-41000<UNITPRICE>0.61<COMMISSION>132.05<TAXES>0<FEES>0<TOTAL>24877.95<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448651C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>9000<UNITPRICE>0.61<COMMISSION>34.45<TAXES>0<FEES>0<TOTAL>-5524.45<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615048C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>450<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-274.5<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615049C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>4000<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-2440<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448646C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>450<UNITPRICE>0.61<COMMISSION>1.37<TAXES>0<FEES>0<TOTAL>-275.87<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448647C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>4000<UNITPRICE>0.61<COMMISSION>12.2<TAXES>0<FEES>0<TOTAL>-2452.2<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615058C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-450<UNITPRICE>0.61<COMMISSION>1.37<TAXES>0<FEES>0<TOTAL>273.13<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615059C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-4000<UNITPRICE>0.61<COMMISSION>12.2<TAXES>0<FEES>0<TOTAL>2427.8<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615055C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>31000<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-18910<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448656C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>5000<UNITPRICE>0.61<COMMISSION>15.25<TAXES>0<FEES>0<TOTAL>-3065.25<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448654C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>10000<UNITPRICE>0.61<COMMISSION>30.5<TAXES>0<FEES>0<TOTAL>-6130.5<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615066C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-10000<UNITPRICE>0.61<COMMISSION>30.5<TAXES>0<FEES>0<TOTAL>6069.5<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615068C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-5000<UNITPRICE>0.61<COMMISSION>15.25<TAXES>0<FEES>0<TOTAL>3034.75<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615050C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>13500<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-8235<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448648C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>13500<UNITPRICE>0.61<COMMISSION>41.18<TAXES>0<FEES>0<TOTAL>-8276.18<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615060C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-13500<UNITPRICE>0.61<COMMISSION>41.18<TAXES>0<FEES>0<TOTAL>8193.82<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615062C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-15000<UNITPRICE>0.61<COMMISSION>45.75<TAXES>0<FEES>0<TOTAL>9104.25<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615052C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>15000<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-9150<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448650C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>15000<UNITPRICE>0.61<COMMISSION>45.75<TAXES>0<FEES>0<TOTAL>-9195.75<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561448645C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-50000<UNITPRICE>0.61<COMMISSION>159.5<TAXES>0<FEES>0<TOTAL>30340.5<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561280143C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>50000<UNITPRICE>0.61<COMMISSION>159.5<TAXES>0<FEES>0<TOTAL>-30659.5<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448652C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>2050<UNITPRICE>0.61<COMMISSION>13.25<TAXES>0<FEES>0<TOTAL>-1263.75<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615054C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>2050<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-1250.5<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615064C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-2050<UNITPRICE>0.61<COMMISSION>13.25<TAXES>0<FEES>0<TOTAL>1237.25<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK></INVTRANLIST>
        """

        treebuilder = ofxtools.Parser.TreeBuilder()
        treebuilder.feed(ofx)
        invtranlist = ofxtools.models.base.Aggregate.from_etree(treebuilder.close())

        elan = Security.merge(self.session, uniqueidtype='CUSIP', uniqueid='28413U204')
        self.reader.securities[('CUSIP', '28413U204')] = elan

        fi = Fi(brokerid='dch.com', name='Dewey Cheatham & Howe')
        self.reader.account = FiAccount(fi=fi, number='5678', name='Test')
        self.session.add(self.reader.account)

        self.reader.currency_default = 'USD'

        self.reader.doTrades(invtranlist)
        trans = self.reader.transactions

        #  print()
        #  print('*' * 79)
        #  for tran in trans:
            #  print(tran)
        #  print()
        #  print(sum([tran.units for tran in trans]))
        #  print(len(trans))

        #  print('*' * 79)


#  class CashTransactionsTestCase(DatabaseTest, unittest.TestCase):
    #  def testDoCashTransactions(self):
        #  ofx = """
#  <INVTRANLIST> <DTSTART>20160331202000.000[-4:EDT]</DTSTART> <DTEND>20160429202000.000[-4:EDT]</DTEND> <INCOME> <INVTRAN> <FITID>20160413.U999999.e.USD.6352363694</FITID> <DTTRADE>20160413202000.000[-4:EDT]</DTTRADE> <MEMO>RHDGF(ANN741081064) CASH DIVIDEND 5.00000000 USD PER SHARE (Return of Capital)</MEMO> </INVTRAN> <SECID> <UNIQUEID>ANN741081064</UNIQUEID> <UNIQUEIDTYPE>ISIN</UNIQUEIDTYPE> </SECID> <INCOMETYPE>DIV</INCOMETYPE> <TOTAL>138215</TOTAL> <SUBACCTSEC>CASH</SUBACCTSEC> <SUBACCTFUND>CASH</SUBACCTFUND> <CURRENCY> <CURRATE>1.0</CURRATE> <CURSYM>USD</CURSYM> </CURRENCY> </INCOME> <INVEXPENSE> <INVTRAN> <FITID>20160413.U999999.e.USD.6356130554</FITID> <DTTRADE>20160413202000.000[-4:EDT]</DTTRADE> <MEMO>RHDGF(ANN741081064) CASH DIVIDEND 5.00000000 USD PER SHARE - REVERSAL (Return of Capital)</MEMO> </INVTRAN> <SECID> <UNIQUEID>ANN741081064</UNIQUEID> <UNIQUEIDTYPE>ISIN</UNIQUEIDTYPE> </SECID> <TOTAL>-138215</TOTAL> <SUBACCTSEC>CASH</SUBACCTSEC> <SUBACCTFUND>CASH</SUBACCTFUND> <CURRENCY> <CURRATE>1.0</CURRATE> <CURSYM>USD</CURSYM> </CURRENCY> </INVEXPENSE> <INCOME> <INVTRAN> <FITID>20160413.U999999.e.USD.6356130558</FITID> <DTTRADE>20160413202000.000[-4:EDT]</DTTRADE> <MEMO>RHDGF(ANN741081064) CASH DIVIDEND 5.00000000 USD PER SHARE (Return of Capital)</MEMO> </INVTRAN> <SECID> <UNIQUEID>ANN741081064</UNIQUEID> <UNIQUEIDTYPE>ISIN</UNIQUEIDTYPE> </SECID> <INCOMETYPE>DIV</INCOMETYPE> <TOTAL>139000</TOTAL> <SUBACCTSEC>CASH</SUBACCTSEC> <SUBACCTFUND>CASH</SUBACCTFUND> <CURRENCY> <CURRATE>1.0</CURRATE> <CURSYM>USD</CURSYM> </CURRENCY> </INCOME> </INVTRANLIST>
        #  """

        #  #  element = ET.fromstring(xml)
        #  treebuilder = ofxtools.Parser.TreeBuilder()
        #  treebuilder.feed(ofx)
        #  invtranlist = ofxtools.models.base.Aggregate.from_etree(treebuilder.close())

        #  rhdgf = Security.merge(self.session, uniqueidtype='ISIN', uniqueid='ANN741081064')
        #  self.reader.securities[('ISIN', 'ANN741081064')] = rhdgf

        #  fi = Fi(brokerid='dch.com', name='Dewey Cheatham & Howe')
        #  self.reader.account = FiAccount(fi=fi, number='5678', name='Test')
        #  self.session.add(self.reader.account)

        #  self.reader.doCashTransactions(invtranlist)
        #  trans = self.reader.transactions

        #  # <INVEXPENSE> cancels first <INCOME>
        #  self.assertEqual(len(trans), 1)
        #  tran = trans.pop()
        #  self.assertIsInstance(tran, Transaction)
        #  self.assertEqual(tran.uniqueid, '20160413.U999999.e.USD.6356130558')
        #  # FIXME - timezone adjustment
        #  #  self.assertEqual(tran.datetime, datetime(2016, 4, 13, 20, 20))
        #  self.assertEqual(tran.type, 'returnofcapital')
        #  self.assertEqual(tran.memo, 'RHDGF(ANN741081064) CASH DIVIDEND 5.00000000 USD PER SHARE (Return of Capital)')
        #  self.assertEqual(tran.currency, 'USD')
        #  self.assertEqual(tran.cash, Decimal('139000'))
        #  self.assertEqual(tran.fiaccount, self.reader.account)
        #  self.assertEqual(tran.security, rhdgf)
        #  self.assertEqual(tran.units, None)
        #  self.assertEqual(tran.securityPrice, None)
        #  self.assertEqual(tran.fiaccountFrom, None)
        #  self.assertEqual(tran.securityFrom, None)
        #  self.assertEqual(tran.unitsFrom, None)
        #  self.assertEqual(tran.securityFromPrice, None)
        #  self.assertEqual(tran.numerator, None)
        #  self.assertEqual(tran.denominator, None)
        #  self.assertEqual(tran.sort, None)


if __name__ == '__main__':
    unittest.main(verbosity=3)
